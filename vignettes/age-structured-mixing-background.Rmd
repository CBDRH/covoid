---
title: "Age structured epidemic models"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{age-structured-mixing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
p.caption {
  font-size: 0.8em;
}
</style>

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
#library(covoid)
library(ggplot2)
library(DiagrammeR)

devtools::load_all()
```


## Outline

This article ...

* topic 1  
* topic 2  
* topic 3  

## Introduction

The transmission of infectious agents is influenced by several factors, including the biology and behaviour of the host. These components are heavily influenced by age. People spend a disproportionally large amount of time in environments such kindergatens, school, workplaces, households and nursing homes. This skew their chance of contacting certain age groups. Accounting for uneven age contacts in epidemic models can aid in understanding the impact and dynamics of disease in a population. (Therefore, it is crucial to take into account the host age structure to enable realistic modeling for disease prevention policy). For instance, there is strong evidence that COVID-19 has a higher fatality rate in older and comorbid people, suggested as a potential factor in the high mortality rate observed in norther Italy (red). By considering age modelling of the impact of control measures and spread of disease allows for fine grained results. We can separate out potential impact of school or university closures from strict distancing measures in nursing homes.  

This article describes the considerations necessary when moving from the homogeneous SIR or SEIR model to more complex (discrete) age structure models, and how to use covoid to model these situations (figure 1). Throughout we will assume stable demography, i.e. no migration and birth or death. THis assumption is reasonable over short time frames where the distribution of individuals is unlkely to shift sufficiently to result in large groups of newly uninfected individuals. However it should be relaxed for longer time frames.

## Age structure population

In order to introduce heterogeneity additional information is required. A homogeneous compartmental model required knowledge or estimates of the population size N, and breakdowns into the given compartments, along with disease dynamics parameters, at the very least the probability of infection given contact , kappa the contact rate and gamma the invers of the length of illness. A key addition for the heterogeneous case is the contact rates between groups and population distributions. For $J$ groups this An additional $J(J + 1)$ parameters. Thankfully we have available We use contact matrices split into home, school, work and other (Prem et al). 
Previous research by Prem (REF) has created contact matrices for five year age groups for 152 countries. see figure. These allow us to model our population as being composed of $i = 1,...,I$ discrete age groups (e.g. (0,5], (5,10],...). Within covoid these matrices can be imported for XXXX countries - see `foo` for the full list - using the `import_contact_matrix` function which takes the arguments country and XXX, which is one of "school", "work", "other", "home" or "general". The general matrix is the sum of the other four. A `plot` method utilising ggplot2 has been introduced for these matrices allowing quick visualising (see figure).

```{r,fig.cap="*Figure 1:* Contact matrices for school, work, home and other locations (source: Prem et al ()). Note the differing scales.",fig.width=7,fig.height=5}
cm_oz_s <- import_contact_matrix("Australia","school")
cm_oz_w <- import_contact_matrix("Australia","work")
cm_oz_o <- import_contact_matrix("Australia","other")
cm_oz_h <- import_contact_matrix("Australia","home")
p1 = plot(cm_oz_s) + 
    scale_fill_continuous(name="Contact\nrate",type = "viridis") +
    labs(title="School",x="Age of individual",y="Age of contact") +
    theme(axis.text = element_text(size = 5))
p2 = plot(cm_oz_w) + 
    scale_fill_continuous(name="Contact\nrate",type = "viridis") +
    labs(title="Work",x="Age of individual",y="Age of contact")+
    theme(axis.text = element_text(size = 5))
p4 = plot(cm_oz_o) + 
    scale_fill_continuous(name="Contact\nrate",type = "viridis") +
    labs(title="Other",x="Age of individual",y="Age of contact")+
    theme(axis.text = element_text(size = 5))
p3 = plot(cm_oz_h) + 
    scale_fill_continuous(name="Contact\nrate",type = "viridis") +
    labs(title="Home",x="Age of individual",y="Age of contact")+
    theme(axis.text = element_text(size = 5))
gridExtra::grid.arrange(p1,p2,p3,p4,ncol=2)
```

The covoid package also contains age distributions for XXX, sourced from XXX. These can be imported imported for XXXX countries - see `foo` for the full list - using the `import_age_distribution` function. A `plot` method utilising ggplot2 has been introduced for these allowing quick visualising (see figure).

```{r,fig.cap="*Figure 2:* hello",fig.height=2,fig.width=6}
plot(import_age_distribution("Australia")) +
    labs(x = "Age (years)",y = "Proportion of the\npopulation")+
            ggplot2::geom_bar(stat = "identity",fill="midnightblue")+
    theme_bw() +
    coord_cartesian(expand=FALSE) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.border = element_blank(),axis.line.x = element_line(),
          axis.line.y = element_line())
```

The contact rate between an individual in age group $i$ and age group $j$ is $\kappa_{ij}$. As above generally $\kappa_{ij} \ne \kappa_{ji}$ due to the non-uniform distribution of age in human societies. The lack of symmetry is illustrated in figure 1. 

```{r,fig.height=3.5,fig.width=3.5,fig.cap="*Figure 3:* Asymmetry of contact rates. Each point represents an individual and the shaded area the individuals they will contact in the next time step. On average each red will contact ~1-3 reds, and 0-1 blues. Blues will meet ~1 red and 0 blues."}
set.seed(1234)
n = 22
x = runif(n)
y = runif(n)
col=sample(x = 2:3,size = n,prob=c(0.75,0.25),replace=TRUE)
df = data.frame(x,y,col)
ggplot(df,aes(x=x,y=y,color=factor(col))) +
  geom_point() +
  geom_point(alpha=0.1,size=35) +
  guides(legend=FALSE) +
  theme_void() +
  theme(legend.position = "none")
```


## Mathematical model

```{r,fig.cap="Homogeneous mixing",fig.align="center"}
grViz("
digraph SEIR {

  # a 'graph' statement
  graph [overlap = false,
    fontsize = 10,
    labelloc = t,
    fontname = Helvetica]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  S[label='S_i'];
  E[label='E_i'];
  I[label='I_i'];
  R[label='R_i'];

  # several 'edge' statements
  S->E
  E->I
  I->R
}
",height=200,width=700)
```


here are $N_i$ individuals in each age group, with susceptible-infected-removed compartments $S_i$, $I_i$ and $R_i$. $p_i = \frac{N_i}{N}$

If an individual in group $i$ meets an individual from group $j$ the chance this contact is infected is $\frac{I_j}{N_j}$.

Assume a constant probability of disease transmission $\beta$. 

Combining these terms we have the chance a susceptible individual in $S_i$ meets and is infected by an individual in $I_j$ is $\beta \kappa_{ij} \frac{I_j}{N_j}$. Summing this over all susceptible individuals in $i$, and all infected in $j$ gives $$S(t+ \Delta_t) = S(t) - \sum_{i=1}^{|S_i|} \sum_{j=1}^{J} \beta \kappa_{ij} \frac{I_j}{N_j}\Delta_t = S(t) - S_i \sum_{j=1}^{J} \beta \kappa_{ij} \frac{I_j}{N_j}\Delta_t$$.

By bring $S(T)$ to the left hand side and dividing through and taking the taking the limit as $\Delta_t \to 0$ we have the usual differential equation form. In the case where there are $k=1,...,K$ stages of infectiousness, we have

$$\frac{dS}{dt} = - S_i \sum_{j=1}^{J} \beta \kappa_{ij} \sum_{k=1}^{K} \frac{I_{kj}}{N_j}$$
While this may seem redundant now, since $I_j = \sum_{k=1}^{K} I_{jk}$, it will comes in use when we consider modelling interventions and differences in hospitalisation or testing rates across the compartments.

## An example

Split the population into adults and children. We can construct the contact matrix $K$ with $(i,j)^{th}$ element $\kappa_{ij}$. From table 1 we see that a child has 5.8 contacts with other children and 2.6 contacts with an adult per unit of time. The proportion of adults and children in the population is $p_a$ and $p_c$.

```{r}
cm = matrix(c(5.8,1.3,2.6,1.9),ncol=2,byrow = TRUE)
knitr::kable(cm,col.names = c("Individual: child","Individual: adult"),caption="Source: Blackwood, Childs")
```

Our SIR system, with the subscripts $a$ and $c$ denoting adult and child is

$$ 
\begin{align}
\frac{dS_c}{dt} &= -S_c\beta(\kappa_{cc}\frac{I_c}{N_c} + \kappa_{ca}\frac{I_a}{N_a}) \\
\frac{dS_a}{dt} &= -S_a\beta(\kappa_{aa}\frac{I_a}{N_a} + \kappa_{ac}\frac{I_c}{N_c}) \\
\frac{dI_c}{dt} &= S_a\beta(\kappa_{aa}\frac{I_a}{N_a} + \kappa_{ac}\frac{I_c}{N_c}) - \gamma I_c\\
\frac{dI_a}{dt} &= S_a\beta(\kappa_{aa}\frac{I_a}{N_a} + \kappa_{ac}\frac{I_c}{N_c}) - \gamma I_a\\
\end{align}
$$

We drop $\frac{dR_i}{dt}$ as it is not relevant to the spread of the infection.

## Interventions

Interventions (e.g. social distancing) can reduce either the contact rate $\kappa_{ij}$ or the probabililty of transmission $\beta$. As these terms are linearly combined in the SIR/SEIR models we don't differentiate our interventions act upon one or both. An intervention that reduces the transmissability $\beta \kappa_{ij} = \tau_{ij}$ of the disease from group $i$ to $j$ is denoted by $Y_{ij}$ and takes a value in $(0,1)$. For example, social distancing.... Some interventions may act at certain stages, for example self-isolation of people with respiratory symptoms, leading to a general form

$$\frac{dS}{dt} = - S_i \sum_{j=1}^{J} \tau_{ij} \sum_{k=1}^{K} Y_{kij} \frac{I_{kj}}{N_j}$$

Some sort of logistic function, steps etc.

We disagrrgate our contact matrix into a contact matrices for different settings school (e.g. figure) so we can assess the impact of interventions. For instance, suppose closing school reduces contact rates of students with other students by 80% on average. One way to achive this is  multiply our contact matrix $C$ by a diagonal matrix $CC$ with elements 0.2 getting $C_i = C CM$.

Maybe difference over ages, e.g. reducing contact between group i and everyone else by 90% and group j by not at all then 


```{r}
CC = diag(c(0.5,1))

MM = CC
MM[MM == 1] = 0
MM = 2*MM
# before
cm
# after
tmp = CC %*% cm %*% CC 
tmp + MM %*% tmp %*% MM
```


## The basic reproduction number


Note that the basic reproduction number is a threshold
parameter for invasion of a disease organism into a completely susceptible
population; once the disease has begun to spread, conditions favouring spread
will change and Ro may no longer be a good measure of disease transmission. (Driessche &
& Watmough)

However, in many models R0 is related ot the peak and final threshold of a epidemic.

R0 a number and a ratio of rates

In the current model R0 is also a threshold parameter for exponential growth (although N must be large - in small samples it is possible that no exponential growth occurs).

```{r,fig.cap="*Figure 4:* Epidemic growth and R0",fig.height=4,fig.width=6}
cm_oz <- import_contact_matrix("Australia","general")
dist_oz <- import_age_distribution("Australia")
nJ = ncol(cm_oz)
S = rep(4e6,nJ)
E = rep(10,nJ)
I = rep(10,nJ)
R = rep(0,nJ)
state0 <- seir_c_state0(S = S,E = E,I = I,R = R)

R0 <- seq(0.8,1.2,0.05)
df = data.frame(t = numeric(),I = numeric(), R0 = numeric())
for (i in 1:length(R0)) {
    param <- seir_c_param(R0 = R0[i],gamma = 0.1,sigma=0.1,cm=cm_oz,dist=dist_oz)
    res <- simulate_seir_c(t = 500,state_t0 = state0,param = param)
    df = rbind(df,
               data.frame(t = 1:500,
                I = res$epi$I,
                R0 = rep(R0[i],500)))
}
df$less1 = factor(1*(df$R0 < 1))

ggplot(df) +
    geom_line(aes(x = t, y = I, col = R0, group = R0),size=0.7) +
    coord_cartesian(ylim = c(0,1000),xlim = c(0,500),expand = FALSE) +
    theme_bw() +
    scale_y_continuous(breaks = seq(200,1000,200)) +
    labs(title = "Initial growth of infection",x = "Time",
         y = "Number of infectious") +
    scale_color_continuous(name = expression('R'[0]),type="viridis") +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```



The basic reproduction number $\mathcal{R_0}$ is the expected number of secondary cases produced, in a completely susceptible population, by a typical infected individual during its entire period of infectiousness (Dieckmann et al 1990). For complex models there is not a uniformly accepted mathod for calculating $\mathcal{R_0}$. As shown by Li et al (2010) the various methods give different answers. This suggest that for the discrete heterogeneous model we described can calculate it as 

The next generation approach.

Not the same answer.

The next generation matrix is:

```{r,eval=FALSE}
gamma = 0.6
V = diag(rep(gamma,2))
F1 = t(0.1*cm)
p = c(pc,pa)
for (i in 1:2) {
  for (j in 1:2) {
    F1[i,j] = (p[i]/p[j])*F1[i,j]
  }
}
F = F1

K = F %*% solve(V)
eigen(K)
```

We get an $R_0 = 3.26$


```{r,eval=FALSE}
param <- sir_c_param(R0 = 1.0,gamma = 0.1,cm = cm,p = c(pc,pa))
state0 <- sir_c_state0(S0 = c(333,666),I0 = c(2,1),R0 = c(0,0))
res <- simulate_c_sir(t = 200,state_t0 = state0,param = param)
plot(res,c("S","E","I","R"))
```


