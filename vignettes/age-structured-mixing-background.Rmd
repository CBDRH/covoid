---
title: "Age structured epidemic models"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{age-structured-mixing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
p.caption {
  font-size: 0.8em;
}
</style>

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
#library(covoid)
library(ggplot2)
library(DiagrammeR)

devtools::load_all()
```


## Introduction

The SIR and SEIR models assume homogeneous mixing in the population. However, this assumption is unrealistic. People spend a disproportionally large amount of time in environments such kindergatens, school, workplaces, households and nursing homes. This skew their chance of contacting certain age groups. Accounting for differnetial age contacts in epidemic models can aid in understanding the impact and dynamics of disease in a population. For instance, there is strong evidence that COVID-19 has a higher fatality rate in older and comorbid people but in some countries (e.g. Australia) has been found to be more prevalent in younger age groups. By considering age modelling of the impact of control measures and spread of disease allows for fine grained results. We can separate out potential impact of school or university closures from strict distancing measures in nursing homes.  

Our goal is to describe the considerations necessary when moving from the homogeneous SIR or SEIR models  to more complex (discrete) age structure models (figure 1). Throughout we will assume stable demography, i.e. no migration and birth or death. THis assumption is reasonable over short time frames where the distribution of individuals is unlkely to shift sufficiently to result in large groups of newly uninfected individuals. However it should be relaxed for longer time frames.


```{r,fig.cap="Homogeneous mixing"}

graph1 = grViz("
digraph SIR {

  # a 'graph' statement
  graph [overlap = false,
    fontsize = 10,
    labelloc = t,
    label='Placeholder',
    fontname = Helvetica]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  S[label='S'];
  I[label='I'];
  R[label='R'];
  S1[label='S'];
  I1[label='I'];


  # several 'edge' statements
  S->I
  I->R
  S1->I1
}
")
graph2 = graph1

library(htmltools)
browsable(
  tagList(list(
    tags$div(
      style = 'width:50%;align:left;float:left;',
      graph1
    ),
    tags$div(
      style = 'width:50%;align:left;float:left;',
      graph2
    )
  ))
)
```

## Age structure population

Previous research by Prem (REF) has created contact matrices for five year age groups for 152 countries.

In order to introduce heterogeneity additional information is required. A basic SIR model required knowledge or estimates of the population size N, and breakdowns into the SIR compartments, along with disease dynamics parameters beta, the probability of infection given contact , kappa the contact rate and gamma the invers of the length of illness. A key addition for the heterogeneous case is the contact rates between groups and population distributions. For $J$ groups this An additional $J(J + 1)$ parameters. We use contact matrices split into home, school, work and other (Prem). If we also want differing transmission probabilities between groups there are $2 J(J+1)$, although we will assume it is not varying.

Suppose we model our population as being composed of $i = 1,...,I$ discrete age groups (e.g. (0,5], (5,10],...). There are $N_i$ individuals in each age group, with susceptible-infected-removed compartments $S_i$, $I_i$ and $R_i$. $p_i = \frac{N_i}{N}$

The contact rate between an individual in age group $i$ and age group $j$ is $\kappa_{ij}$. As above generally $\kappa_{ij} \ne \kappa_{ji}$ due to the non-uniform distribution of age in human societies. The lack of symmetry is illustrated in figure 1. 

```{r,fig.height=4,fig.width=4,fig.cap="*Figure 1:* Asymmetry of contact rates. Each point represents an individual and the shaded area the individuals they will contact in the next time step. On average each red will contact ~1-3 reds, and 0-1 blues. Blues will meet ~1 red and 0 blues."}
set.seed(1234)
n = 22
x = runif(n)
y = runif(n)
col=sample(x = 2:3,size = n,prob=c(0.75,0.25),replace=TRUE)
df = data.frame(x,y,col)
ggplot(df,aes(x=x,y=y,color=factor(col))) +
  geom_point() +
  geom_point(alpha=0.1,size=35) +
  guides(legend=FALSE) +
  theme_void() +
  theme(legend.position = "none")
```

If an individual in group $i$ meets an individual from group $j$ the chance this contact is infected is $\frac{I_j}{N_j}$.

Assume a constant probability of disease transmission $\beta$. 

Combining these terms we have the chance a susceptible individual in $S_i$ meets and is infected by an individual in $I_j$ is $\beta \kappa_{ij} \frac{I_j}{N_j}$. Summing this over all susceptible individuals in $i$, and all infected in $j$ gives $$S(t+ \Delta_t) = S(t) - \sum_{i=1}^{|S_i|} \sum_{j=1}^{J} \beta \kappa_{ij} \frac{I_j}{N_j}\Delta_t = S(t) - S_i \sum_{j=1}^{J} \beta \kappa_{ij} \frac{I_j}{N_j}\Delta_t$$.

By bring $S(T)$ to the left hand side and dividing through and taking the taking the limit as $\Delta_t \to 0$ we have the usual differential equation form. In the case where there are $k=1,...,K$ stages of infectiousness, we have

$$\frac{dS}{dt} = - S_i \sum_{j=1}^{J} \beta \kappa_{ij} \sum_{k=1}^{K} \frac{I_{kj}}{N_j}$$
While this may seem redundant now, since $I_j = \sum_{k=1}^{K} I_{jk}$, it will comes in use when we consider modelling interventions and differences in hospitalisation or testing rates across the compartments.

## An example

Split the population into adults and children. We can construct the contact matrix $K$ with $(i,j)^{th}$ element $\kappa_{ij}$. From table 1 we see that a child has 5.8 contacts with other children and 2.6 contacts with an adult per unit of time. The proportion of adults and children in the population is $p_a$ and $p_c$.

```{r}
cm = matrix(c(5.8,1.3,2.6,1.9),ncol=2,byrow = TRUE)
knitr::kable(cm,col.names = c("Individual: child","Individual: adult"),caption="Source: Blackwood, Childs")
```

Our SIR system, with the subscripts $a$ and $c$ denoting adult and child is

$$ 
\begin{align}
\frac{dS_c}{dt} &= -S_c\beta(\kappa_{cc}\frac{I_c}{N_c} + \kappa_{ca}\frac{I_a}{N_a}) \\
\frac{dS_a}{dt} &= -S_a\beta(\kappa_{aa}\frac{I_a}{N_a} + \kappa_{ac}\frac{I_c}{N_c}) \\
\frac{dI_c}{dt} &= S_a\beta(\kappa_{aa}\frac{I_a}{N_a} + \kappa_{ac}\frac{I_c}{N_c}) - \gamma I_c\\
\frac{dI_a}{dt} &= S_a\beta(\kappa_{aa}\frac{I_a}{N_a} + \kappa_{ac}\frac{I_c}{N_c}) - \gamma I_a\\
\end{align}
$$

We drop $\frac{dR_i}{dt}$ as it is not relevant to the spread of the infection.

## Interventions

Interventions (e.g. social distancing) can reduce either the contact rate $\kappa_{ij}$ or the probabililty of transmission $\beta$. As these terms are linearly combined in the SIR/SEIR models we don't differentiate our interventions act upon one or both. An intervention that reduces the transmissability $\beta \kappa_{ij} = \tau_{ij}$ of the disease from group $i$ to $j$ is denoted by $Y_{ij}$ and takes a value in $(0,1)$. For example, social distancing.... Some interventions may act at certain stages, for example self-isolation of people with respiratory symptoms, leading to a general form

$$\frac{dS}{dt} = - S_i \sum_{j=1}^{J} \tau_{ij} \sum_{k=1}^{K} Y_{kij} \frac{I_{kj}}{N_j}$$

Some sort of logistic function, steps etc.

We disagrrgate our contact matrix into a contact matrices for different settings school (e.g. figure) so we can assess the impact of interventions. For instance, suppose closing school reduces contact rates of students with other students by 80% on average. One way to achive this is  multiply our contact matrix $C$ by a diagonal matrix $CC$ with elements 0.2 getting $C_i = C CM$.

Maybe difference over ages, e.g. reducing contact between group i and everyone else by 90% and group j by not at all then 


```{r}
CC = diag(c(0.5,1))

MM = CC
MM[MM == 1] = 0
MM = 2*MM
# before
cm
# after
tmp = CC %*% cm %*% CC 
tmp + MM %*% tmp %*% MM
```


## The basic reproduction number


Note that the basic reproduction number is a threshold
parameter for invasion of a disease organism into a completely susceptible
population; once the disease has begun to spread, conditions favouring spread
will change and Ro may no longer be a good measure of disease transmission. (Driessche &
& Watmough)

However, in many models R0 is related ot the peak and final threshold of a epidemic.

R0 a number and a ratio of rates


The basic reproduction number $\mathcal{R_0}$ is the expected number of secondary cases produced, in a completely susceptible population, by a typical infected individual during its entire period of infectiousness (Dieckmann et al 1990). For complex models there is not a uniformly accepted mathod for calculating $\mathcal{R_0}$. As shown by Li et al (2010) the various methods give different answers. This suggest that for the discrete heterogeneous model we described can calculate it as 

$$
\begin{align}
\mathcal{R_{0,i}} &= \frac{1}{\gamma} \sum_{j=1}^J \tau_{ij} \\ 
\mathcal{R_0} &= \sum_{i=1}^I p_i R_{0,i}
\end{align}
$$

This is equivalent to the survival function method in Li $R_0 = E(?) = \int_0^{\infty}E(infections)p()da$ where we assume everything is exponential.

```{r}
beta = 0.1
gamma = 0.2
cm
pa = 2/3
pc = 1/3

# children
r0_c = (1/gamma)*sum(beta*cm[,1])
# adults
r0_a = (1/gamma)*sum(beta*cm[,2])

pa*r0_a + pc*r0_c
```

Computing the Jacobian.



The next generation approach.

Not the same answer.

The next generation matrix is:

```{r}
gamma = 0.6
V = diag(rep(gamma,2))
F1 = t(0.1*cm)
p = c(pc,pa)
for (i in 1:2) {
  for (j in 1:2) {
    F1[i,j] = (p[i]/p[j])*F1[i,j]
  }
}
F = F1

K = F %*% solve(V)
eigen(K)
```

We get an $R_0 = 3.26$


```{r}
param <- sir_c_param(R0 = 1.0,gamma = 0.1,cm = cm,p = c(pc,pa))
state0 <- sir_c_state0(S0 = c(333,666),I0 = c(2,1),R0 = c(0,0))
res <- simulate_c_sir(t = 200,state_t0 = state0,param = param)
plot(res,c("S","I","R"))
```

