---
title: "Proposed COVOID-d model development"
author: "Oisin Fitzgerald, Mark Hanly, Tim Churches"
date: "03/05/2020"
always_allow_html: true
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dev = 'pdf')
options(tinytex.verbose = TRUE)

library(DiagrammeR)
library(tidyverse)
library(readxl)
library(gt)
```

## Introduction 

 The compartment model of Moss _et al_. (2020) appears to have been constructed prior to the start of the COVID-19 epidemic in Australia (that is, prior to Feb 2020) and was primarily designed to assess the potential impact of COVID-19 on the Australian hospital system. As described, it allows for modelling of the following interventions or behavioural modifcations aimed at reducing the spread of SARS-CoV-2 infection:
 
* isolation of cases (defined as "confirmed by a medical practitioner")
* voluntary self-quarantine of contacts of cases
* indefinite (ongoing), fixed levels of physical/social distancing
* an indefinite (ongoing) fixed level of imported cases

Based on events since the start of the local COVID-19 epidemic, and as at the time of writing, there has been widespread government responses, centred around social/physical distancing, and gradually liberalised testing criteria, allied with ongoing case-based interventions (case identification and isolation, contact tracing and quarantining), together with near closure of the borders and mandatory quarantine for all arrivals. These measures have resulted in an impressive reduction in incident cases across Australia, a few localised of point source outbreaks notwithstanding). 

The questions now are what is the "exit strategy" from the economically and socially harmful widespread social distancing measures? With this in mind, we propose the model shown below, dubbed _**COVOID-d**_, to permit the exploration of future scenarios involving both current interventions and behaviours, such as:

* self-isolation if symptomatic (even minor symptoms), pending readily available testing (including testing-at-home, mobile teams come to you);
* varying levels of social distancing;
* school closure, tertiary education clusore or partial closure (eg small tutorials but not lectures);
time-varying numbers of imported cases;
* enhanced and more efficient contact tracing through scaled-up public health workforces (with ADF assistance) and deployment of low-power BlueTooth mobile-phone-assisted contact tracing;
* "drive-through" and "pop-up" or mobile testing facilities, particularly in hot spots.

With later addition of:

* serological testing and seroserveys;
* vaccination strategies

### Modelling critical public health intervention capacities

So far, focus of most modelling groups has been on ICU capacity, in particular ventilated beds (and implicitly ECMO capacity). However, with the near-eradication scenarios which now seem likely in Australia, New Zealand, South Korea and Taiwan, it is far less likely that ICU or even general hospital capacity will be overwhelmed unless control of the epipemic is lost. Such loss of control is entirely possible, as evinced by Japan and Singapore, both of which had their initial COVID-19 outbreaks under control through moderate social distancing but strong case-based interventions. However, to ensure prevention such failures of control when local transmission and external seeding have been reduced to low numbers, it is important to consider not hospital treatment capacity but public health intervention capacity.

These case-based public health capacities comprise:

* border control, specifically rigorous quarantining (and potentially testing) of all arrivals
* case isolation for those tested positive, and facilitation of self-isolation for pre-test potential cases
* case detection through widespread _ad hoc_ or organised sampled testing
* contact tracing and contact quarantine (with daily follow-up, and potentially, testing) 

These capacities are largely constrained by workforce size and lab capacity, including RT-PCR reagent supplies and lab personnel capacity.

We should be able to model scenarios in which each or all of the above capabilities are constrained at current levels, and examine the impact of increasing amounts of local transmission. 

### From "flattening the curve" to "keep it flat"

There needs to be a paradigm shift from "flattening the curve" in order to keep the prevalent number of serious cases below hospital and ICU capacity, to "keep it flat" in order to prevent the number of undetected local transmission chains from rising (due to restricted testing and poor self-isolation), and to prevent  the number of detected local transmission chains from outstripping the capacity of case-based public health interventions (isolation. contact tracing and quarantine) to suppress them.

## Moss _et al._ SEIMR-Q model

This is the structure of the Moss _et al_.) (2020) model as described, as best as we can understand it (in the absence of any released source code for its implementation). It contains peculiarities and uses various "short-cuts" to approximate the modelling of certain scenarios.

We have re-implemented this as a dynamic model (which is the type used by Moss _et al_.) using the _EpiModel_ library and framework for _R_. We are attempting to use it to reproduce the rather few model outputs given in the Moss _et al._ paper, in order to demonstrate the faithfulness of the results obtained from implementation to theirs. We will include it in our released code, and mention it in any scientific papers based on this initiative, but we do not believe it is adequate for modelling purposes henceforth.

```{r moss_et_al, eval=TRUE, message=FALSE, fig.cap="Moss et al./Doherty Institute model, as recreated"}
grViz("
digraph SEIMRQ {

  # a 'graph' statement
  graph [overlap = false, fontsize = 10]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  S[label='S\nsusceptible'];
  E1[label='E&#x2081;\nexposed,\nasymptomatic,\nnon-infectious'];
  E2[label='E&#x2082;\nexposed,\nasymptomatic,\ninfectious'];
  I1[label='I&#x2081;\nsymptomatic,\ninfectious,\nearly stage'];
  I2[label='I&#x2082;\nsymptomatic,\ninfectious,\nlater stage'];
  M[label='M\nunder\nmedical\ncare'];
  R[label='R\nremoved\n(recovered/immune,\ndeceased)'];
  Rm[label='Rm\nrecovered/\nimmune\n(under\nmedical\ncare)'];
  E1s[label='E&#x2081;&#x02E2;\nexposed,\nasymptomatic,\nnon-infectious,\n(self-quarantined)'];
  E2s[label='E&#x2082;&#x02E2;\nexposed,\nasymptomatic,\ninfectious,\n(self-quarantined)'];
  I1s[label='I&#x2081;&#x02E2;\nsymptomatic,\ninfectious,\nearly stage,\n(was self-\nquarantined)'];
  I2s[label='I&#x2082;&#x02E2;\nsymptomatic,\ninfectious,\nlater stage,\n(was self-\nquarantined)'];
  Ms[label='M&#x02E2;\nunder\nmedical\ncare,\n(was self-\nquarantined)'];
  Rs[label='R&#x02E2;\nremoved\n(recovered/immune,\ndeceased)\n(was self-\nquarantined)'];
  Rms[label='Rm&#x02E2;\nremoved\n(recovered/immune,\ndeceased)\n(under\nmedical\ncare,\n(was self-\nquarantined)'];

  # several 'edge' statements
  S->E1
  E1->E2
  E2->I1
  I1->I2
  I2->R
  I1->M
  M->Rm
  S->E1s
  E1s->E2s
  E2s->I1s
  I1s->I2s
  I2s->Rs
  I1s->Ms
  Ms->Rms
}
")
```

\clearpage

### Moss _et al._/Doherty Institute model parameter definitions

```{r doherty-ui-table}

doh_ui <- read_excel("vignettes/doherty_params_of.xlsx")

doh_ui %>%
  gt()
```

\newpage

## COVOID-d model

The diagram on the following page shows the **COVOID-d** model as implemented. It also contains some inelegant but unavoidable duplication, in particular the almost complete branching of the model at an early stage to accommodate modelling of quarantine of asymptomatic contacts of cases (something which the Moss _et al_. model "fudges" through a mathematical short-cut). Nonetheless, we think it has the capability to explore most of the scenarios set out above. The red dashed lines in the diagram which follows indicate routes of infection. In theory, there should be an equivalent set of infectivity routes to the S^C^ compartment too, but we will assume that route is negligible for the sake of simplicity and tractability of implementation.

\newpage
\blandscape

```{r covoid-d, eval=TRUE, message=FALSE, fig.cap="Implemented COVOID-d model"}
grViz("
digraph COVOIDd {

  overlap = false;
  fontsize = 10;
  node [shape = box, fontname = Helvetica]

  S[label='S\nsusceptible'];
  Sc[label='S&#x1D9C;\nsusceptible\n(quarantined contact)'];
  R[label='R\nremoved\n(recovered/immune,\ndeceased)'];
  Rh[label='Rh\nremoved\n(recovered/immune,\ndeceased)\n(required\nhospitalisation)'];
  Rc[label='R&#x1D9C;\nremoved\n(recovered/immune,\ndeceased)\n(was quarantined contact)'];
  Rhc[label='Rh&#x1D9C;\nremoved\n(recovered/immune,\ndeceased)\n(required\nhospitalisation)\n(was quarantined contact)'];

  # a 'graph' statement
  subgraph cluster_0 {
    label='Asymptomatic';
    color=green;
    style=filled;
    node [shape = box, fontname = Helvetica]
    E1[label='E1\nexposed/infected,\nasymptomatic,\nnon-infectious'];
    E1c[label='E1&#x1D9C;\nexposed/infected,\nasymptomatic,\nnon-infectious\n(quarantined contact)'];
  }

  subgraph cluster_1 {
    label='Asymptomatic & infectious';
    color=yellow;
    style=filled;
    node [shape = box, fontname = Helvetica]
    E2[label='E2\nexposed/infected,\nasymptomatic,\ninfectious'];
    E2c[label='E2&#x1D9C;\nexposed/infected,\nasymptomatic,\ninfectious\n(was quarantined contact)'];
  }
  
  subgraph cluster_2 {
    label='Infectious';
    color=orange;
    style=filled;
    node [shape = box, fontname = Helvetica]
    I1[label='I1\ninfected,\nsymptomatic,\ninfectious,\nearly stage'];
    I2[label='I2\ninfected,\nsymptomatic,\ninfectious,\nlater stage'];
    T[label='T\ninfected,\ntest +ve,\nin isolation'];
    H[label='H\ninfected,\nrequires/is hospitalised'];
    I1c[label='I1&#x1D9C;\ninfected,\nsymptomatic,\ninfectious,\nearly stage\n(was quarantined contact)'];
    I2c[label='I2&#x1D9C;\ninfected,\nsymptomatic,\ninfectious,\nlater stage\n(was quarantined contact)'];
    Tc[label='T&#x1D9C;\ninfected,\ntest +ve,\nin isolation\n(was quarantined contact)'];
    Hc[label='H&#x1D9C;\ninfected,\nrequires/is hospitalised\n(was quarantined contact)'];
  }

  # several 'edge' statements
  S->E1
  E1->E2
  E2->I1
  E2->I1c
  I1->I2
  I2->R
  I1->H
  H->Rh
  I1->T
  T->R
  I1->I2c
  S->Sc
  Sc->S
  S->E1c
  E1c->E2c
  E2c->I1c
  I1c->I2c
  I1c->Tc
  I2c->Rc
  I1c->Hc
  Tc->Rc
  Hc->Rhc
  T->S[style=dashed color=red]
  Tc->S[style=dashed  color=red]
  H->S[style=dashed color=red]
  Hc->S[style=dashed color=red]
  E2->S[style=dashed color=red]
  E2c->S[style=dashed color=red]
  I1->S[style=dashed color=red]
  I1c->S[style=dashed color=red]
  I2->S[style=dashed color=red]
  I2c->S[style=dashed color=red]
}
")
```

\elandscape

\newpage

### COVOID-d compartment definitions

| Compartment | Definition                          |
|--------|-------------------------------------|
| S      | susceptible |
| E1   | exposed/infected; asymptomatic; non-infectious|
| E2   | exposed/infected; asymptomatic; infectious|
| I1   | infected, symptomatic, infectious, early stage|
| I2   | infected, symptomatic, infectious, later stage|
| T      | infected, tested positive, in isolation|
| H      | infected, symptomatic, infectious, requires hospitalisation|
| R      | removed (recovered/immune, deceased)|
| Rh   | removed (recovered/immune, deceased), required hospitalsiation|
| S^C^   | susceptible; contact of a case in quarantine|
| E1^C^ | exposed/infected; asymptomatic; non-infectious; contact of a case in quarantine|
| E2^C^ | exposed/infected; asymptomatic; infectious; contact of a case in quarantine|
| I1^C^ | infected, symptomatic, infectious, early stage; contact of a case in quarantine/isolation|
| I2^C^ | infected, symptomatic, infectious, later stage; contact of a case in quarantine/isolation|
| T^C^    | infected, tested positive, in isolation; contact of a case in quarantine|
| H^C^      | infected, symptomatic, infectious, requires hospitalisation; contact of a case |
| R^C^      | removed (recovered/immune, deceased); contact of a case|
| Rh^C^   | removed (recovered/immune, deceased), required hospitalsiation; contact of a case|

Note the meaning of the following flows:

| Flow | Interpretation                          |
|--------|-------------------------------------|
| E2 &#x2192; I1^C^ | immediate self-isolation upon onset of symptoms |
| I1 &#x2192; T | tested positive for COVID-19 but doesn't require hospitalisation|
| S &#x2192; E1^C^ | enters 14 day quarantine contact with a case |

### COVOID-d system of equations

| Parameter      | Definition                          |
|----------------|-------------------------------------|
| $\lambda$      | force of infection                  |
| others         | to be completed                     |

$$
\begin{aligned} 
\lambda_i &= \sum{p^T \cdot IM_{*,i} \cdot CM_{i,*} \cdot \frac{E\it{2} + I1m + I1s + I2}{N}} \\
          &+ (1 - Q_{eff}) \cdot \sum{p^T \cdot IM_{*,i} \cdot CM_{i,*} \cdot \frac{E\it{2}^C + I1m^C + I1s^C + I2^C}{N}} \\
          &+ (1 - T_{eff}) \cdot \sum{p^T \cdot IM_{*,i} \cdot CM_{i,*} \cdot \frac{T + T^C}{N}} \\
          &+ (1 - H_{eff}) \cdot \sum{p^T \cdot IM_{*,i} \cdot CM_{i,*} \cdot \frac{H + H^C}{N}}
\end{aligned} 
$$

$$
\begin{aligned} 
\frac{dS_i}{dt} &= -S_{i} \cdot \lambda_{i} \\
\frac{dE\it{1}_i}{dt} &= (1 - \delta) \cdot S_{i} \cdot \lambda_{i} - \sigma_1 \cdot E\it{1}_i \\
\frac{dE\it{2}_i}{dt} &= \sigma_1 \cdot E\it{1}_i - \sigma_2 \cdot E2_i \\
\frac{dI\it{1}m_i}{dt} &= (1 - p_{severe}) \cdot \sigma_2 \cdot E2_i  - \gamma_1 \cdot I\it{1}m_1 \\
\frac{dI\it{1}s_i}{dt} &= p_{severe} \cdot \sigma_2 \cdot E2_i  - \gamma_1 \cdot I\it{1}s_i \\
\frac{dI\it{2}_i}{dt} &= (1 - p_{isolate}) \cdot \gamma_1 \cdot I\it{1}m_i  - \gamma_2 \cdot I\it{2}_i \\
\frac{dT_i}{dt} &= p_{isolate} \cdot \gamma_1 \cdot I\it{1}m_i  - \gamma_2 \cdot T_i \\
\frac{dH_i}{dt} &= \gamma_1 \cdot I\it{1}s_i  - \gamma_2 \cdot H_i \\
\frac{dS^C_i}{dt} &= 0 \\
\frac{dE\it{1}^C_i}{dt} &= \delta \cdot S_{i} \cdot \lambda_{i} - \sigma_1 \cdot E\it{1}^C_i \\
\frac{dE\it{2}^C_i}{dt} &= \sigma_1 \cdot E\it{1}^C_i - \sigma_2 \cdot E2^C_i \\
\frac{dI\it{1}m^C_i}{dt} &= (1 - p_{severe}) \cdot \sigma_2 \cdot E2^C_i  - \gamma_1 \cdot I\it{1}m^C_1 \\
\frac{dI\it{1}s^C_i}{dt} &= p_{severe} \cdot \sigma_2 \cdot E2^C_i  - \gamma_1 \cdot I\it{1}s^C_i \\
\frac{dI\it{2}^C_i}{dt} &= (1 - p_{isolate}) \cdot \gamma_1 \cdot I\it{1}m^C_i  - \gamma_2 \cdot I\it{2}^C_i \\
\frac{dT^C_i}{dt} &= p_{isolate} \cdot \gamma_1 \cdot I\it{1}m^C_i  - \gamma_2 \cdot T^C_i \\
\frac{dH^C_i}{dt} &= \gamma_1 \cdot I\it{1}s^C_i  - \gamma_2 \cdot H^C_i \\
\frac{dR_i}{dt} &= \gamma_2 \cdot T_i  + \gamma_2 \cdot I\it{2}_i + \gamma_2 \cdot T^C_i  + \gamma_2 \cdot I\it{2}^C_i \\
\frac{dRh_i}{dt} &= \gamma_2 \cdot H_i  + \gamma_2 \cdot H^C_i
\end{aligned} 
$$

\newpage

## Proposed user interface elements

In addition, we will provide a simple graphical user interface that will allow users to visualise the proposed transmission model, and interactively modified the model parameters to explore results under different scenarios. 

```{r, out.width="100%", fig.cap="Proposed COVOID-d user interface - parameter specification"}
knitr::include_graphics(path = here::here("vignettes/model-gui-1.png"))
```

```{r, out.width="100%", fig.cap="Proposed COVOID-d user interface - time-variant parameter specification interface - users can point and click"}
knitr::include_graphics(path = here::here("vignettes/model-gui-3.png"))
```

```{r, out.width="100%", fig.cap="Proposed COVOID-d user interface - running the model and obtaining results as a self-contained report"}
knitr::include_graphics(path = here::here("vignettes/model-gui-2.png"))
```

This interface will be embedded as part of a downloadable _R_ package (see below), enabling it to be run by anyone on a laptop or desktop computer (Windows, Apple MacOS and Linux supported) following about 10 minutes to install the free, open-source R statistical computing environment. We will provide detailed installation and usage notes. It will also be made available as an installation-free web app for policy-makers and journalists.  

Users of the app will be able to generate and download customisable dynamic reports based on scenarios they define, that summarise the results as well as document the underlying assumptions and model parameter settings.

\newpage

## Implementation details

Following best practice, we will make our source code open and available so that other researchers can verify, replicate and extend our results. 

