---
title: "Model Summary Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

```

## Summary

This is a dynamic report genearted by `COVOIDd::covis()`. The scenario was based on a `r input$nsteps` day window between `r format(as.Date(input$dateRange[1], origin=1970-01-01), "%B %d, %Y")` and `r format(as.Date(input$dateRange[2], origin=1970-01-01), "%B %d, %Y")`.  

The total population size was `r popcounter()`, and `r default$e1_num()` were individuals were assumed to carry the latently virus on day 1. 


## The compartment model

```{r}

    nodes <- data.frame(id = 1:15,

        # add labels on nodes
        label = c('S', 'E1', 'E2', 'I1', 'I2', 'M', 'R', 'Rm',
                  'E1q', 'E2q', 'I1q', 'I2q', 'Mq', 'Rq', 'Rmq'),

        # size adding value
        size = c(rep(10, 15)),

        # Hierarchical level
        level = c(0,1,1,1,1,2,1,2,3,3,3,3,4,3,4),

        # Group
        group = c("Susceptible", rep("Latent", 2), rep("Infectious", 2), "Managed", rep("Recovered", 2),
                  rep("Latent", 2), rep("Infectious", 2), "Managed", rep("Recovered", 2)
                  ),

        # control shape of nodes
        shape = c(rep("square", 15)),

        font.color = c(rep("grey", 15)),

        # Don't need physics
        physics = rep(FALSE, 15),

        shadow = c(rep(FALSE,8), rep(TRUE,7)),
        

        # tooltip (html or character), when the mouse is above
        title = c(HTML(paste0("S", br(), 'Susceptible')),
                  HTML(paste0("E", tags$sub("1"), br(), "Latent period", br(), em("(First stage)"))),
                  HTML(paste0("E", tags$sub("2"), br(), "Latent period", br(), em("(Second stage)"))),
                  HTML(paste0("I", tags$sub("1"), br(), "Infectious period", br(), em("(First stage)"))),
                  HTML(paste0("I", tags$sub("2"), br(), "Infectious period", br(), em("(Second stage)"))),
                  HTML(paste0("M", br(), 'Managed cases from I', tags$sub("1"))),
                  HTML(paste0("R", br(), 'Recovered')),
                  HTML(paste0("R", tags$sub("M"), br(), "Recovered individuals that were managed")),
                  HTML(paste0("E", tags$sub("1"), tags$sup("q"), " [Quarantined]", br(), "Latent period", br(), em("(First stage)"))),
                  HTML(paste0("E", tags$sub("2"), tags$sup("q"), " [Quarantined]", br(), "Latent period", br(), em("(Second stage)"))),
                  HTML(paste0("I", tags$sub("1"), tags$sup("q"), " [Quarantined]", br(), "Infectious period", br(), em("(First stage)"))),
                  HTML(paste0("I", tags$sub("2"), tags$sup("q"), " [Quarantined]", br(), "Infectious period", br(), em("(Second stage)"))),
                  HTML(paste0("M", tags$sup("q"), " [Quarantined]", br(), 'Managed cases from I', tags$sub("1"), tags$sup("q"))),
                  HTML(paste0("R", tags$sup("q"), " [Quarantined]", br(), 'Recovered')),
                  HTML(paste0("R", tags$sub("M"),  tags$sup("q"), " [Quarantined]", br(), "Recovered individuals that were managed"))
        )

   )

    edges <- data.frame(from = c(1, 2, 3, 4, 4, 5, 6, 1, 9, 10, 11, 11, 12, 13),
        to = c(2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15),
        id = LETTERS[seq( from = 1, to = 14 )],
        dashes = c(rep(FALSE,7), rep(TRUE,7)),

        # Label text
        label = c(
            round(default$lambda()*(1-(default$rho()*default$thetam())), digits=2),
            round(default$sigma1(), digits=2),
            round(default$sigma2(), digits=2),
            round(default$gamma1()*(1 - default$alpha()*default$pm()), digits=2),
            round(default$gamma1()*(default$alpha()*default$pm()), digits=2),
            round(default$gamma2(), digits=2),
            round(default$gamma2(), digits=2),
            round(default$lambda()*(default$rho()*default$thetam()), digits=2),
            round(default$sigma1(), digits=2),
            round(default$sigma2(), digits=2),
            round(default$gamma1q()*(1 - default$alpha()*default$pm()), digits=2),
            round(default$gamma1q()*(default$alpha()*default$pm()), digits=2),
            round(default$gamma2q(), digits=2),
            round(default$gamma2q(), digits=2)
            ),

        # Label colour
        font.color = c(rep("darkgrey", 14)),

        # Hover titles
        title = c(HTML('&lambda;(1-&rho;&sdot;&Theta;<sub>M</sub>)'),
                  HTML('&sigma;<sub>1</sub>'),
                  HTML('&sigma;<sub>2</sub>'),
                  HTML('&gamma;<sub>1</sub>(1 - &alpha;P<sub>M</sub>)'),
                  HTML('&gamma;<sub>1</sub>(&alpha;P<sub>M</sub>)'),
                  HTML('&gamma;<sub>2</sub>'),
                  HTML('&gamma;<sub>2</sub>'),
                  HTML('&lambda;(&rho;&sdot;&Theta;<sub>M</sub>)'),
                  HTML('&sigma;<sub>1</sub>'),
                  HTML('&sigma;<sub>2</sub>'),
                  HTML('&gamma;<sub>1</sub><sup>q</sup>(1 - &alpha;P<sub>M</sub>)'),
                  HTML('&gamma;<sub>1</sub><sup>q</sup>(&alpha;P<sub>M</sub>)'),
                  HTML('&gamma;<sub>2</sub><sup>q</sup>'),
                  HTML('&gamma;<sub>2</sub><sup>q</sup>')
                  )
    )


    visNetwork(nodes, edges, submain = HTML("See <a href='https://www.doherty.edu.au/uploads/content_doc/McVernon_Modelling_COVID-19_07Apr1_with_appendix.pdf' target='_blank'>
                                            Moss <em>et al</em> (2020)</a> Technical Appendix, Figure 1")) %>%
        visHierarchicalLayout(direction = "UD", levelSeparation = 80) %>%
        visEdges(arrows = "to") %>%
        visGroups(groupname = "Susceptible", color = "lightblue") %>%
        visGroups(groupname = "Latent", color = "orange") %>%
        visGroups(groupname = "Infectious", color = "red") %>%
        visGroups(groupname = "Managed", color = "pink") %>%
        visGroups(groupname = "Recovered", color = "lightgreen") %>%
        visGroups(groupname = "Other", shape = "icon", icon = list(code = "f7d9", size = 25)) %>%
        visLegend(width = 0.1, position = "left", main = "Compartment") %>%
        visOptions(nodesIdSelection = list(enabled = TRUE)) %>%
        visInteraction(hover = TRUE) %>%
        visPhysics(stabilization = FALSE)

```



```{r}
model <- COVOIDd::simulate_seimrqc(t = nsteps(), state_t0 = state0(), param = param())

# Extract the data
 mod_df <- pivot_longer(model$epi, -t, names_to = "compartment", values_to = "count") %>%
        mutate(complong = recode(compartment,
                                 S = "Susceptible",
                                 E1 = "Exposed (first stage)",
                                 E2 = "Exposed (second stage)",
                                 I1 = "Infected (first stage)",
                                 I2 = "Infected (second stage)",
                                 R = "Recovered non-quar",
                                 M = "Managed non-quar",
                                 Rm = "Recovered from managed)",
                                 Eq1 = "Exp quar (first stage)",
                                 Eq2 = "Exp quar (second stage)",
                                 Iq1 = "Inf quar (first stage)",
                                 Iq2 = "Inf quar (second stage)",
                                 Rq = "Recovered quar",
                                 Rqm = "Rec quar managed",
                                 CTm = "Contacts of managed cases",
                                 CTnm = "Contacts of unmanaged cases",
                                 Itotal = "Infected",
                                 I = "",
                                 Ictotal = "",
                                 Mtotal = "Managed",
                                 H = "Hospitalised",
                                 D = "Fatalities",
                                 Q = "Quarantined",
                                 N = "Population"),
               date = as.Date(t + input$dateRange[1] - 1, origin = "1970-01-01")) %>%
        group_by(compartment) %>%
        arrange(t) %>%
        mutate(cum_sum = cumsum(count)) %>%
        mutate(lab1 = sprintf("<strong>%s</strong><strong>%s</strong><br/><strong>%s</strong><strong>%s</strong><strong>%s</strong><strong>%s</strong><strong>%s</strong><br/>%s",
                             "Day: ", t,
                             "Count: ", formatC(round(count, digits = 0), format="d", big.mark=','),
                             " (", round(100*count/popcounter(), digits = 1), "%)",
                             complong) %>% lapply(htmltools::HTML)) %>%
        mutate(lab2 = sprintf("<strong>%s</strong><strong>%s</strong><br/><strong>%s</strong><strong>%s</strong><strong>%s</strong><strong>%s</strong><strong>%s</strong><br/>%s",
                             "Day: ", t,
                             "Cuml: ", formatC(round(cum_sum, digits = 0), format="d", big.mark=','),
                             " (", round(100*cum_sum/popcounter(), digits = 1), "%)",
                             complong) %>% lapply(htmltools::HTML))
 

## Define the plots
 
     ### Update tooltip based on choice of graph
tooltip <- ifelse(input$yvar=="count", "lab1", "lab2")
compcols <- c("S" = "lightblue", "Itotal" = "red", "Mtotal" = "pink", "H" = "maroon", "Q" = "Purple", "Rtotal" = "lightgreen", "D" = "Black" )
complabels <- c("S" = "Susceptible", "Itotal" = "Infected", "MTotal" = "Managed", "H" = "Hospitalised", "Q" = "Quarantined", "Rtotal" = "Recovered", "D" = "Case fatality")


p1 <- mod_df %>%
  filter(compartment %in% input$plotvars) %>%
  filter(t <= input$ndays) %>%
  ggplot(aes_string(x="date", y="count", colour="compartment")) +
  geom_line(size=2, alpha=0.7) +
  scale_x_date(date_labels="%d%b%Y") +
  theme_dark() +
  theme(legend.position = "right", legend.title = element_blank()) +
  guides(col = guide_legend(ncol = 1)) +
  labs(x="Date", y="Prevalence (persons)") +
  scale_colour_manual(values = compcols, labels=complabels) +
  geom_point_interactive(aes_string(tooltip = tooltip))

p2 <- mod_df %>%
    filter(compartment %in% input$plotvars) %>%
    filter(t <= input$ndays) %>%
    ggplot(aes_string(x="date", y="count", colour="compartment")) +
    geom_line(size=2, alpha=0.7) +
    scale_x_date(date_labels="%d%b%Y") +
    theme_dark() +
    theme(legend.position = "right", legend.title = element_blank()) +
    guides(col = guide_legend(ncol = 1)) +
    labs(x="Date", y="Prevalence (persons - log scale)") +
    scale_colour_manual(values = compcols, labels=complabels) +
    geom_point_interactive(aes_string(tooltip = tooltip)) +
    scale_y_log10()

p3 <- mod_df %>%
    filter(compartment %in% input$plotvars) %>%
    filter(t <= input$ndays) %>%
    ggplot(aes_string(x="date", y="count", colour="compartment")) +
    geom_line(size=2, alpha=0.7) +
    scale_x_date(date_labels="%d%b%Y") +
    theme_dark() +
    theme(legend.position = "right", legend.title = element_blank()) +
    guides(col = guide_legend(ncol = 1)) +
    labs(x="Date", y="Percentage (%)") +
    scale_colour_manual(values = compcols, labels=complabels) +
    geom_point_interactive(aes_string(tooltip = tooltip))

p4 <- mod_df %>%
      filter(compartment %in% input$plotvars) %>%
      filter(t <= input$ndays) %>%
      ggplot(aes_string(x="date", y="cum_sum", colour="compartment")) +
      geom_line(size=2, alpha=0.7) +
      scale_x_date(date_labels="%d%b%Y") +
      theme_dark() +
      theme(legend.position = "right", legend.title = element_blank()) +
      guides(col = guide_legend(ncol = 1)) +
      labs(x="Date", y="Prevalence (persons)") +
      scale_colour_manual(values = compcols, labels=complabels) +
      geom_point_interactive(aes_string(tooltip = tooltip))

p5 <- mod_df %>%
    filter(compartment %in% input$plotvars) %>%
    filter(t <= input$ndays) %>%
    ggplot(aes_string(x="date", y="cum_sum", colour="compartment")) +
    geom_line(size=2, alpha=0.7) +
    scale_x_date(date_labels="%d%b%Y") +
    theme_dark() +
    theme(legend.position = "right", legend.title = element_blank()) +
    guides(col = guide_legend(ncol = 1)) +
    labs(x="Date", y="Prevalence (persons - log scale)") +
    scale_colour_manual(values = compcols, labels=complabels) +
    geom_point_interactive(aes_string(tooltip = tooltip)) +
    scale_y_log10()

p6 <- mod_df %>%
    filter(compartment %in% input$plotvars) %>%
    filter(t <= input$ndays) %>%
    ggplot(aes_string(x="date", y="cum_sum", colour="compartment")) +
    geom_line(size=2, alpha=0.7) +
    scale_x_date(date_labels="%d%b%Y") +
    theme_dark() +
    theme(legend.position = "right", legend.title = element_blank()) +
    guides(col = guide_legend(ncol = 1)) +
    labs(x="Date", y="Percentage (%)") +
    scale_colour_manual(values = compcols, labels=complabels) +
    geom_point_interactive(aes_string(tooltip = tooltip))
                           
                           

```

## Results

### Incidence

```{r}
p1
```


### Cumulative incidence

```{r}
p4
```




## Summary of underlying parameters

### Initial conditions

```{r}

initTable <- data.frame(
  Compartment = c("$S$",
                  "$E_{1}$",
                  "$E_{2}$",
                  "$I_{1}$",
                  "$I_{2}$",
                  "$R$",
                  "$M$",
                  "$R_{M}^{q}$",
                  "$E_{1}^{q}$",
                  "$E_{2}^{q}$",
                  "$I_{1}^{q}$",
                  "$I_{2}^{q}$",
                  "$R^{q}$",
                  "$M^{q}$",
                  "$R_{M}^{q}$",
                  "$CT_{NM}$",
                  "$CT_{M}$"),
  
  Quarantined = c(rep("No",8), rep("Yes",7), rep("", 2)),
  
  Description = c("Susceptible individuals", 
                  "Latent period (first stage)", 
                  "Latent period (second stage)", 
                  "Infectious period (first stage)", 
                  "Infectious period (second stage)", 
                  "Recovered individuals", 
                  "Managed cases", 
                  "Recovered individuals that were managed cases", 
                  "Latent period (first stage)", 
                  "Latent period (second stage)", 
                  "Infectious period (first stage)", 
                  "Infectious period (second stage)", 
                  "Recovered individuals", 
                  "Managed cases", 
                  "Recovered individuals that were managed cases",
                  "Contacts of unmanaged cases",
                  "Contacts of managed cases"),
  Count = c(
    default$s_num(),
    default$e1_num(),
    default$e2_num(),
    default$i1_num(),
    default$i2_num(),
    default$r_num(),
    default$m_num(),
    default$rm_num(),
    default$e1q_num(),
    default$e2q_num(),
    default$i1q_num(),
    default$i2q_num(),
    default$rq_num(),
    default$mq_num(),
    default$rmq_num(),
    default$ctnm_num(),
    default$ctm_num()
  )
)

kable(initTable, escape = FALSE, caption = "Initial conditions for the model compartments")  %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  column_spec(1, bold = T, border_right = T, width = '15%') %>%
  column_spec(2, width = '15%') %>% 
  column_spec(3, width = "70%") %>% 
  column_spec(4, width = '15%')

```


### Model parameters
```{r}
# Model parameters
paramTable <- data.frame(
  Compartment = c("$R_{0}$",
                  "$\\lambda_{imp}$",
                  "$\\rho$",
                  "$\\sigma_{1}$",
                  "$\\sigma_{2}$",
                  "$\\gamma_{1}$",
                  "$\\gamma_{2}$",
                  "$\\alpha_{m}$",
                  "$P_{M}$",
                  "$\\gamma_{1}^{q}$",
                  "$\\gamma_{2}^{q}$",
                  "$Q_{eff}$",
                  "$M_{eff}$",
                  "$\\eta$",
                  "$\\alpha_{m}\\beta$",
                  "$P_{Hosp|Inf}$",
                  "$\\delta$",
                  "$\\kappa$",
                  "$\\beta$",
                  "$\\beta_{m}^{q}$",
                  "$\\lambda$",
                  "$\\alpha$"
                  ),

  Description = c(
    "The basic reproduction number",  
    "The force of infection from importation",
    "The proportion of contacts (of ascertained cases) that will self-quarantine",
    "Inverse of first latent period",
    "Inverse of second latent period",
    "Inverse of first infectious period",
    "Inverse of second infectious period",
    "Proportion of non-severe people who present ('mild')",
    "Probability of presenting cases being effectively managed",
    "Inverse of first infectious period for quarantined cases",
    "Inverse of second infectious period for quarantined cases",
    "The reduction in infectiousness due to quarantine",
    "The reduction in infectiousness due to case management",
    "Scaling factor for hospitalisation proportion ('severe')",
    "Err, ask Oisin",
    "Probability of hospitalisation given infection",
    "The duration of quarantine for contacts (14 days)",
    "The per-person contact rate (20 people per day)",
    "The force of infection exerted by one individual",
    "The force of infection for managed or quarantined individuals",
    "The net force of infection",
    "Net proportion of people who present"
  ),
  
  Count = c(
        round(default$r0(), digits = 2),
        round(default$lambdaimp(), digits = 2),
        round(default$rho(), digits = 2),
        round(default$sigma1(), digits = 2),
        round(default$sigma2(), digits = 2),
        round(default$gamma1(), digits = 2),
        round(default$gamma2(), digits = 2),
        round(default$alpham(), digits = 2),
        round(default$pm(), digits = 2),
        round(default$gamma1q(), digits = 2),
        round(default$gamma2q(), digits = 2),
        round(default$qeff(), digits = 2),
        round(default$meff(), digits = 2),
        round(default$eta(), digits = 2),
        round(default$alphambeta),
        round(default$probHospGivenInf),
        round(default$delta),
        round(default$kappa),
        round(default$beta(), digits = 2),
        round(default$betamq(), digits = 2),
        round(default$lambda(), digits = 2), 
        round(default$alpha(), digits = 2)
    )
)

kable(paramTable, escape = FALSE, caption = "Model parameters")  %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  column_spec(1, bold = T, border_right = T, width = '15%') %>%
  column_spec(2, width = "70%") %>% 
  column_spec(3, width = '15%')

```




