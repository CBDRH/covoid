---
title: "Model Summary Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Summary

This is a dynamic report generated by `covoid::covis()`. The scenario was based on a `r input$nsteps` day window between `r format(as.Date(input$dateRange[1], origin=1970-01-01), "%B %d, %Y")` and `r format(as.Date(input$dateRange[2], origin=1970-01-01), "%B %d, %Y")`.  

The total population size was `r popcounter()`, and `r default$i_num()` individuals were assumed to be infected at the outset of the simulation.


## The compartment model

```{r}

    nodes <- data.frame(id = 1:3,

        # add labels on nodes
        label = c('S', 'I', 'R'),

        # size adding value
        size = c(rep(10, 3)),

        # Hierarchical level
        level = c(0,0,0),

        # Group
        group = c("Susceptible", "Infectious", "Recovered"),

        # control shape of nodes
        shape = c(rep("square", 3)),

        font.color = c(rep("grey", 3)),

        # Don't need physics
        physics = rep(FALSE, 3),

        shadow = c(rep(FALSE,3)),

        # tooltip (html or character), when the mouse is above
        title = c(HTML(paste0("S", br(), 'Susceptible')),
                  HTML(paste0("I", br(), "Infectious")),
                  HTML(paste0("R", br(), "Recovered"))
        )

    )

    edges <- data.frame(from = c(1, 2),
        to = c(2, 3),
        id = LETTERS[seq( from = 1, to = 2 )],
        dashes = c(rep(FALSE,2)),

        # Label text
        label = c(
            round(999, digits=3),
            round(default$gamma(), digits=3)
            ),

        # Label colour
        font.color = c(rep("darkgrey", 2)),

        # Hover titles
        title = c(HTML('&beta;I/N'),
                  HTML('&gamma;')
                  )
    )


    visNetwork(nodes, edges, submain = HTML("SIR model representation")) %>%
        visHierarchicalLayout(direction = "UD", levelSeparation = 80) %>%
        visEdges(arrows = "to") %>%
        visGroups(groupname = "Susceptible", color = "lightblue") %>%
        visGroups(groupname = "Infectious", color = "red") %>%
        visGroups(groupname = "Recovered", color = "lightgreen") %>%
        visLegend(width = 0.1, position = "left", main = "Compartment") %>%
        visOptions(nodesIdSelection = list(enabled = TRUE)) %>%
        visInteraction(hover = TRUE) %>%
        visPhysics(stabilization = FALSE)

```

## Summary of compartments
```{r}

initTable <- data.frame(
  Compartment = c("$S$",
                  "$I$",
                  "$R$"),
  
  Description = c("Susceptible",
                  "Infectious",
                  "Recovered")
)

knitr::kable(initTable, escape = FALSE, caption = "Initial conditions for the model compartments")  %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  column_spec(1, bold = T, border_right = T, width = '20%') %>%
  column_spec(2, width = "80%")

```

```{r}
### Re-run models and prepare graphs
## Could this be done more elegantly with a loop? surely?
## for(i in 1:6){I don't know how to loop through sequenced variables in R}

# Initialise an empty vector for initial states and initial parameters
# These get added to if the results have been saved in the report
stateVec <- vector()
paramVec <- vector()

if(input$inclPlot1){
   model_p1 <- covoid::simulate_c_sir(t = count$nsteps_p1, state_t0 = count$state0_p1, param = count$param_p1)
   mod_df_p1 <- prepData(df_epi=model_p1$epi, popsize=count$popSize_p1 , day1 = count$startDate_p1)
   plot_p1 <- plotResults(df = mod_df_p1, scale=count$scale_p1, logScale=count$logScale_p1, plotvars=count$plotvars_p1, ndays=count$ndays_p1)
   stateVec <- cbind(stateVec, `Scenario 1` = formatC(round(count$state0_p1, digits=0), format="d", big.mark = ","))
   paramVec <- cbind(paramVec, `Scenario 1` = round(unlist(count$param_p1), digits=3))
}

if(input$inclPlot2){
   model_p2 <- covoid::simulate_c_sir(t = count$nsteps_p2, state_t0 = count$state0_p2, param = count$param_p2)
   mod_df_p2 <- prepData(df_epi=model_p2$epi, popsize=count$popSize_p2 , day1 = count$startDate_p2)
   plot_p2 <- plotResults(df = mod_df_p2, scale=count$scale_p2, logScale=count$logScale_p2, plotvars=count$plotvars_p2, ndays=count$ndays_p2)
   stateVec <- cbind(stateVec, `Scenario 2` = formatC(round(count$state0_p2, digits=0), format="d", big.mark = ","))
   paramVec <- cbind(paramVec, `Scenario 2` = round(unlist(count$param_p2), digits=3))
  }

if(input$inclPlot3){
   model_p3 <- covoid::simulate_c_sir(t = count$nsteps_p3, state_t0 = count$state0_p3, param = count$param_p3)
   mod_df_p3 <- prepData(df_epi=model_p3$epi, popsize=count$popSize_p3 , day1 = count$startDate_p3)
   plot_p3 <- plotResults(df = mod_df_p3, scale=count$scale_p3, logScale=count$logScale_p3, plotvars=count$plotvars_p3, ndays=count$ndays_p3)
   stateVec <- cbind(stateVec, `Scenario 3` = formatC(round(count$state0_p3, digits=0), format="d", big.mark = ","))
   paramVec <- cbind(paramVec, `Scenario 3` = round(unlist(count$param_p3), digits=3))
}

if(input$inclPlot4){
   model_p4 <- covoid::simulate_c_sir(t = count$nsteps_p4, state_t0 = count$state0_p4, param = count$param_p4)
   mod_df_p4 <- prepData(df_epi=model_p4$epi, popsize=count$popSize_p4 , day1 = count$startDate_p4)
   plot_p4 <- plotResults(df = mod_df_p4, scale=count$scale_p4, logScale=count$logScale_p4, plotvars=count$plotvars_p4, ndays=count$ndays_p4)
   stateVec <- cbind(stateVec, `Scenario 4` = formatC(round(count$state0_p4, digits=0), format="d", big.mark = ","))
   paramVec <- cbind(paramVec, `Scenario 4` = round(unlist(count$param_p4), digits=3))
}

if(input$inclPlot5){
   model_p5 <- covoid::simulate_c_sir(t = count$nsteps_p5, state_t0 = count$state0_p5, param = count$param_p5)
   mod_df_p5 <- prepData(df_epi=model_p5$epi, popsize=count$popSize_p5, day1 = count$startDate_p5)
   plot_p5 <- plotResults(df = mod_df_p5, scale=count$scale_p5, logScale=count$logScale_p5, plotvars=count$plotvars_p5, ndays=count$ndays_p5)
   stateVec <- cbind(stateVec, `Scenario 5` = formatC(round(count$state0_p5, digits=0), format="d", big.mark = ","))
   paramVec <- cbind(paramVec, `Scenario 5` = round(unlist(count$param_p5), digits=3))
}

if(input$inclPlot6){
   model_p6 <- covoid::simulate_c_sir(t = count$nsteps_p6, state_t0 = count$state0_p6, param = count$param_p6)
   mod_df_p6 <- prepData(df_epi=model_p6$epi, popsize=count$popSize_p6, day1 = count$startDate_p6)
   plot_p6 <- plotResults(df = mod_df_p5, scale=count$scale_p5, logScale=count$logScale_p5, plotvars=count$plotvars_p6, ndays=count$ndays_p6)
   stateVec <- cbind(stateVec, `Scenario 6` = formatC(round(count$state0_p6, digits=0), format="d", big.mark = ","))
   paramVec <- cbind(paramVec, `Scenario 6` = round(unlist(count$param_p6), digits=3))
 }

```

## Model results

### `r if(input$inclPlot1){input$p1title}`
```{r}
if(input$inclPlot1){
plot_p1
}
```
`r if(input$inclPlot1){input$p1comment}`


### `r if(input$inclPlot1){input$p2title}`
```{r}
if(input$inclPlot2){
plot_p2
}
```
`r if(input$inclPlot2){input$p2comment}`

### `r if(input$inclPlot1){input$p3title}`
```{r}
if(input$inclPlot3){
plot_p3
}
```
`r if(input$inclPlot3){input$p3comment}`

### `r if(input$inclPlot1){input$p4title}`
```{r}
if(input$inclPlot4){
plot_p4
}
```
`r if(input$inclPlot4){input$p4comment}`

### `r if(input$inclPlot1){input$p5title}`
```{r}
if(input$inclPlot5){
plot_p5
}
```
`r if(input$inclPlot5){input$p5comment}`

### `r if(input$inclPlot1){input$p5title}`
```{r}
if(input$inclPlot6){
plot_p6
}
```
`r if(input$inclPlot6){input$p6comment}`




## Appendix. Summary of underlying parameters

### Initial conditions

```{r}

initTable <- cbind(
  Compartment = c(rep("$S$",16),
                  rep("$I$",16),
                  rep("$R$",16)),
    
  Description = c(rep("Susceptible",16),
                  rep("Infectious",16),
                  rep("Recovered",16)),
  
  `Age group` = paste0(seq(from=5, to=80, by=5), "-", seq(from=10, to=85, by=5)),

   stateVec
)

knitr::kable(initTable, escape = FALSE, caption = "Initial conditions for the model compartments")  %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  column_spec(1, bold = T, border_right = T)

```


### Model parameters
# ```{r, warning=FALSE}
# # Model parameters
# paramTable <- cbind(
#   Parameter = c("$R_{0}$",
#                   "$\\lambda_{imp}$",
#                   "$\\rho$",
#                   "$\\sigma_{1}$",
#                   "$\\sigma_{2}$",
#                   "$\\gamma_{1}$",
#                   "$\\gamma_{2}$",
#                   "$\\alpha_{m}$",
#                   "$P_{M}$",
#                   "$\\gamma_{1}^{q}$",
#                   "$\\gamma_{2}^{q}$",
#                   "$Q_{eff}$",
#                   "$M_{eff}$",
#                   "$\\eta$",
#                   "$\\alpha_{m}\\beta$",
#                   "$P_{Hosp|Inf}$",
#                   "$\\delta$",
#                   "$\\kappa$",
#                   "$\\beta$",
#                   "$\\beta_{m}^{q}$",
#                   "$\\lambda$",
#                   "$\\alpha$"
#                   ),
# 
#   Description = c(
#     "The basic reproduction number",  
#     "The force of infection from importation",
#     "The proportion of contacts (of ascertained cases) that will self-quarantine",
#     "Inverse of first latent period",
#     "Inverse of second latent period",
#     "Inverse of first infectious period",
#     "Inverse of second infectious period",
#     "Proportion of non-severe people who present ('mild')",
#     "Probability of presenting cases being effectively managed",
#     "Inverse of first infectious period for quarantined cases",
#     "Inverse of second infectious period for quarantined cases",
#     "The reduction in infectiousness due to quarantine",
#     "The reduction in infectiousness due to case management",
#     "Scaling factor for hospitalisation proportion ('severe')",
#     "Err, ask Oisin",
#     "Probability of hospitalisation given infection",
#     "The duration of quarantine for contacts (14 days)",
#     "The per-person contact rate (20 people per day)",
#     "The force of infection exerted by one individual",
#     "The force of infection for managed or quarantined individuals",
#     "The net force of infection",
#     "Net proportion of people who present"
#   ),
#   paramVec
# )
# 
# knitr::kable(paramTable, escape = FALSE, caption = "Model parameters")  %>%
#   kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
#   column_spec(1, bold = T, border_right = T, width = '15%')

```




